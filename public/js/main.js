'use strict';

var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;
var pos;
var destLatLng;
////////////////////////
//start the party
////////////////////////
function initialize() {
  var mapCanvas = document.getElementById('map-canvas'); //div in the html
  var mapOptions = {
    center: new google.maps.LatLng(36.1667, -86.7833), //NashVegas, TN
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    scrollwheel: false };
  map = new google.maps.Map(mapCanvas, mapOptions);
  console.log('map', map); //this works, produces map object
  // Try HTML5 geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      var infowindow = new google.maps.InfoWindow({
        map: map,
        position: pos,
        //pixelOffset: new google.maps.Size(0, -20),
        content: 'You are here'
      });
      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        animation: google.maps.Animation.DROP,
        title: 'This is your geolocation'
      });
      //copied the next six lines from google, not gonna lie
      google.maps.event.addListener(marker, 'click', toggleBounce);

      function toggleBounce() {
        if (marker.getAnimation() !== null) {
          marker.setAnimation(null);
        } else {
          marker.setAnimation(google.maps.Animation.BOUNCE);
        }
      }
      google.maps.event.addListener(marker, 'click', function () {
        infowindow.open(map, marker); //this should be redone in the infobox class
      });
      map.setCenter(pos);
      console.log('map inside the geolocation function', map);
      //refactored code from weather app
      var btnWhereTo = document.querySelector('#btnWhereTo'); //creates the button element using the id from the button input
      btnWhereTo.onclick = function () {
        // closestHooters();
        calcRoute(pos);
      };
      //adds the calcroute within geolocation because geolocation is the starting point
    }, function () {
      handleNoGeolocation(true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(false);
  }
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Aw snap! Something went wrong with the Geolocation service. Sorry?';
  } else {
    var content = 'Aw, snap! Your browser doesn\'t support geolocation.';
  }
  var options = {
    map: map,
    position: new google.maps.LatLng(36.1667, 86.7833),
    content: content
  };
  var infowindow = new google.maps.InfoWindow(options);
  map.setCenter(options.position);
}
//////////////////////////////
//now returns objects!
//////////////////////////////
function closestHooters() {
  var whereTo = document.querySelector('#whereTo').value.split(' ').join('+');
  var MAPS_URL = 'https://maps.googleapis.com/maps/api/geocode/json?address=';
  $.get(MAPS_URL + whereTo, function (data) {
    console.log('data', data); //now it sees this
    var hootersDistances = [];
    var destLat = data.results[0].geometry.location.lat;
    var destLatCoord = parseFloat(destLat); //otherwise returns a string
    console.log('destination latitude with parstFloat', destLat);
    var destLng = data.results[0].geometry.location.lng;
    var destLngCoord = parseFloat(destLng);
    var destLatLng = new google.maps.LatLng(destLatCoord, destLngCoord);
    console.log('both together; are these numbers?', destLatLng);
    var hooters2ndAve = new google.maps.LatLng(36.1743706, -86.78299390000001);
    var hootersLebanonPike = new google.maps.LatLng(36.18633370000001, -86.63314799999999);
    var hootersLargoDrive = new google.maps.LatLng(36.081514, -86.7095413);
    console.log('both together and the 2nd Ave Hooters', destLatLng, '2nd Ave', hooters2ndAve, 'are these objects?');
    var distSecondAve = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hooters2ndAve);
    var distLebanonPike = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hootersLebanonPike);
    var distLargoDrive = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hootersLargoDrive);
    hootersDistances.push(distLargoDrive, distLebanonPike, distSecondAve);
    var nearestHooters = Math.min.apply(Math, hootersDistances);
    /* var hootersWaypoint = function () {
    if (nearestHooters === distSecondAve) {
      return hooters2ndAve;
    } else if (nearestHooters === distLargoDrive) {
      return hootersLargoDrive;
    } else if (nearestHooters === distLebanonPike) {
      return hootersLebanonPike;
    }
    };hootersWaypoint();
    //moving this marker down to become waypts
    var hootersMarker = new google.maps.Marker({
    position: hooters2ndAve,
    map: map,
    icon: 'http://edwinacevedo.com/directionsFrom/img/hooters-marker.png'
    });*/
  });
}
//////////////////////////////////
//autocomplete for the search box
/////////////////////////////////
var pac_input = document.getElementById('whereTo');
(function pacSelectFirst(input) {
  // store the original event binding function
  var _addEventListener = input.addEventListener ? input.addEventListener : input.attachEvent;

  function addEventListenerWrapper(type, listener) {
    // Simulate a 'down arrow' keypress on hitting 'return' when no pac suggestion is selected,
    // and then trigger the original listener.
    if (type == 'keydown') {
      var orig_listener = listener;
      listener = function (event) {
        var suggestion_selected = $('.pac-item-selected').length > 0;
        if (event.which == 13 && !suggestion_selected) {
          var simulated_downarrow = $.Event('keydown', {
            keyCode: 40,
            which: 40
          });
          orig_listener.apply(input, [simulated_downarrow]);
        }
        orig_listener.apply(input, [event]);
      };
    }
    // add the modified listener
    _addEventListener.apply(input, [type, listener]);
  }
  if (input.addEventListener) input.addEventListener = addEventListenerWrapper;else if (input.attachEvent) input.attachEvent = addEventListenerWrapper;
})(pac_input);
$(function () {
  var autocomplete = new google.maps.places.Autocomplete(pac_input);
});
//////////////////////////////
//draw the route on the map
/////////////////////////////
function calcRoute(pos, destLatLng) {
  //placing the owl, these lines from here
  var markers = []; //this would have been used in an array for the nearby hooters
  var btnWhereTo = document.querySelector('#btnWhereTo');
  google.maps.event.addListener(btnWhereTo, 'click', function (event) {
    addMarker();
  });
  console.log(btnWhereTo);

  function addMarker() {
    var marker = new google.maps.Marker({ //moving this down closer to waypoints
      position: hooters2ndAve,
      map: map,
      image: 'http://edwinacevedo.com/directionsFrom/img/hooters-sauce.png'
    });
    markers.push(marker); //this would have pushed the markers into ana rray
  }
  //to here
  var whereTo = document.querySelector('#whereTo').value;
  var hooters2ndAve = new google.maps.LatLng(36.1743706, -86.78299390000001);
  console.log('hooters2ndAve', hooters2ndAve);
  var waypts = [{
    location: hooters2ndAve, //this is undefined
    stopover: true
  }];
  directionsDisplay = new google.maps.DirectionsRenderer({
    suppressMarkers: true });
  directionsDisplay.setMap(map);
  navigator.geolocation.getCurrentPosition(function (position) {
    var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    var marker = new google.maps.Marker({
      position: hooters2ndAve /*waypts*/,
      map: map,
      icon: 'http://edwinacevedo.com/directionsFrom/img/hooters-marker.png'
    });
    var request = {
      origin: pos, //from geolocation
      destination: whereTo, //from input.value of #whereTo
      waypoints: waypts,
      //placeId: 'ChIJOwE7_GTtwokRFq0uOwLSE9g'
      optimizeWaypoints: false,
      travelMode: google.maps.TravelMode.DRIVING
    };
    console.log('waypts', waypts);
    console.log('marker', marker);
    console.log('map', map);
    console.log('pos', pos);
    console.log('whereTo, this time including the input.value', whereTo);
    directionsService.route(request, function (response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
  });
}
google.maps.event.addDomListener(window, 'load', initialize, calcRoute, closestHooters);
//# sourceMappingURL=data:application/json;base64,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LEVBQUUsS0FBSztBQUN4QixnQkFBVSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU87S0FDM0MsQ0FBQztBQUNGLFdBQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQzlCLFdBQU8sQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE1BQU0sQ0FBQyxDQUFDO0FBQzlCLFdBQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLFdBQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDO0FBQ3hCLFdBQU8sQ0FBQyxHQUFHLENBQUMsOENBQThDLEVBQUUsT0FBTyxDQUFDLENBQUM7QUFDckUscUJBQWlCLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxVQUFVLFFBQVEsRUFBRSxNQUFNLEVBQUU7QUFDM0QsVUFBSSxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxFQUFFLEVBQUU7QUFDN0MseUJBQWlCLENBQUMsYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO09BQzNDO0tBQ0YsQ0FBQyxDQUFDO0dBQ0osQ0FBQyxDQUFDO0NBQ0o7QUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLGNBQWMsQ0FBQyxDQUFDIiwiZmlsZSI6InNyYy9qcy9tYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGRpcmVjdGlvbnNEaXNwbGF5O1xudmFyIGRpcmVjdGlvbnNTZXJ2aWNlID0gbmV3IGdvb2dsZS5tYXBzLkRpcmVjdGlvbnNTZXJ2aWNlKCk7XG52YXIgbWFwO1xudmFyIHBvcztcbnZhciBkZXN0TGF0TG5nO1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vL3N0YXJ0IHRoZSBwYXJ0eVxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5mdW5jdGlvbiBpbml0aWFsaXplKCkge1xuICB2YXIgbWFwQ2FudmFzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21hcC1jYW52YXMnKTsgLy9kaXYgaW4gdGhlIGh0bWxcbiAgdmFyIG1hcE9wdGlvbnMgPSB7XG4gICAgY2VudGVyOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE2NjcsIC04Ni43ODMzKSwgLy9OYXNoVmVnYXMsIFROXG4gICAgem9vbTogMTUsXG4gICAgbWFwVHlwZUlkOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUCxcbiAgICBzY3JvbGx3aGVlbDogZmFsc2UsXG4gIH07XG4gIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAobWFwQ2FudmFzLCBtYXBPcHRpb25zKTtcbiAgY29uc29sZS5sb2coJ21hcCcsIG1hcCk7IC8vdGhpcyB3b3JrcywgcHJvZHVjZXMgbWFwIG9iamVjdFxuICAvLyBUcnkgSFRNTDUgZ2VvbG9jYXRpb25cbiAgaWYgKG5hdmlnYXRvci5nZW9sb2NhdGlvbikge1xuICAgIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XG4gICAgICBwb3MgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKHBvc2l0aW9uLmNvb3Jkcy5sYXRpdHVkZSwgcG9zaXRpb24uY29vcmRzLmxvbmdpdHVkZSk7XG4gICAgICB2YXIgaW5mb3dpbmRvdyA9IG5ldyBnb29nbGUubWFwcy5JbmZvV2luZG93KHtcbiAgICAgICAgbWFwOiBtYXAsXG4gICAgICAgIHBvc2l0aW9uOiBwb3MsXG4gICAgICAgIC8vcGl4ZWxPZmZzZXQ6IG5ldyBnb29nbGUubWFwcy5TaXplKDAsIC0yMCksXG4gICAgICAgIGNvbnRlbnQ6ICdZb3UgYXJlIGhlcmUnXG4gICAgICB9KTtcbiAgICAgIHZhciBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcbiAgICAgICAgcG9zaXRpb246IHBvcyxcbiAgICAgICAgbWFwOiBtYXAsXG4gICAgICAgIGFuaW1hdGlvbjogZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkRST1AsXG4gICAgICAgIHRpdGxlOiAnVGhpcyBpcyB5b3VyIGdlb2xvY2F0aW9uJ1xuICAgICAgfSk7XG4gICAgICAvL2NvcGllZCB0aGUgbmV4dCBzaXggbGluZXMgZnJvbSBnb29nbGUsIG5vdCBnb25uYSBsaWVcbiAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcmtlciwgJ2NsaWNrJywgdG9nZ2xlQm91bmNlKTtcblxuICAgICAgZnVuY3Rpb24gdG9nZ2xlQm91bmNlKCkge1xuICAgICAgICBpZiAobWFya2VyLmdldEFuaW1hdGlvbigpICE9PSBudWxsKSB7XG4gICAgICAgICAgbWFya2VyLnNldEFuaW1hdGlvbihudWxsKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBtYXJrZXIuc2V0QW5pbWF0aW9uKGdvb2dsZS5tYXBzLkFuaW1hdGlvbi5CT1VOQ0UpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdjbGljaycsIGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaW5mb3dpbmRvdy5vcGVuKG1hcCwgbWFya2VyKTsgLy90aGlzIHNob3VsZCBiZSByZWRvbmUgaW4gdGhlIGluZm9ib3ggY2xhc3NcbiAgICAgIH0pO1xuICAgICAgbWFwLnNldENlbnRlcihwb3MpO1xuICAgICAgY29uc29sZS5sb2coJ21hcCBpbnNpZGUgdGhlIGdlb2xvY2F0aW9uIGZ1bmN0aW9uJywgbWFwKTtcbiAgICAgIC8vcmVmYWN0b3JlZCBjb2RlIGZyb20gd2VhdGhlciBhcHBcbiAgICAgIHZhciBidG5XaGVyZVRvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2J0bldoZXJlVG8nKTsgLy9jcmVhdGVzIHRoZSBidXR0b24gZWxlbWVudCB1c2luZyB0aGUgaWQgZnJvbSB0aGUgYnV0dG9uIGlucHV0XG4gICAgICBidG5XaGVyZVRvLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIC8vIGNsb3Nlc3RIb290ZXJzKCk7XG4gICAgICAgIGNhbGNSb3V0ZShwb3MpO1xuICAgICAgfTtcbiAgICAgIC8vYWRkcyB0aGUgY2FsY3JvdXRlIHdpdGhpbiBnZW9sb2NhdGlvbiBiZWNhdXNlIGdlb2xvY2F0aW9uIGlzIHRoZSBzdGFydGluZyBwb2ludFxuICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgIGhhbmRsZU5vR2VvbG9jYXRpb24odHJ1ZSk7XG4gICAgfSk7XG4gIH0gZWxzZSB7XG4gICAgLy8gQnJvd3NlciBkb2Vzbid0IHN1cHBvcnQgR2VvbG9jYXRpb25cbiAgICBoYW5kbGVOb0dlb2xvY2F0aW9uKGZhbHNlKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBoYW5kbGVOb0dlb2xvY2F0aW9uKGVycm9yRmxhZykge1xuICAgIGlmIChlcnJvckZsYWcpIHtcbiAgICAgIHZhciBjb250ZW50ID0gJ0F3IHNuYXAhIFNvbWV0aGluZyB3ZW50IHdyb25nIHdpdGggdGhlIEdlb2xvY2F0aW9uIHNlcnZpY2UuIFNvcnJ5Pyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBjb250ZW50ID0gJ0F3LCBzbmFwISBZb3VyIGJyb3dzZXIgZG9lc25cXCd0IHN1cHBvcnQgZ2VvbG9jYXRpb24uJztcbiAgICB9XG4gICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICBtYXA6IG1hcCxcbiAgICAgIHBvc2l0aW9uOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE2NjcsIDg2Ljc4MzMpLFxuICAgICAgY29udGVudDogY29udGVudFxuICAgIH07XG4gICAgdmFyIGluZm93aW5kb3cgPSBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdyhvcHRpb25zKTtcbiAgICBtYXAuc2V0Q2VudGVyKG9wdGlvbnMucG9zaXRpb24pO1xuICB9XG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvL25vdyByZXR1cm5zIG9iamVjdHMhXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuZnVuY3Rpb24gY2xvc2VzdEhvb3RlcnMoKSB7XG4gICAgdmFyIHdoZXJlVG8gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjd2hlcmVUbycpLnZhbHVlLnNwbGl0KCcgJykuam9pbignKycpO1xuICAgIHZhciBNQVBTX1VSTCA9ICdodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvZ2VvY29kZS9qc29uP2FkZHJlc3M9JztcbiAgICAkLmdldChNQVBTX1VSTCArIHdoZXJlVG8sIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICBjb25zb2xlLmxvZygnZGF0YScsIGRhdGEpOyAvL25vdyBpdCBzZWVzIHRoaXNcbiAgICAgIHZhciBob290ZXJzRGlzdGFuY2VzID0gW107XG4gICAgICB2YXIgZGVzdExhdCA9IGRhdGEucmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvbi5sYXQ7XG4gICAgICB2YXIgZGVzdExhdENvb3JkID0gcGFyc2VGbG9hdChkZXN0TGF0KTsgLy9vdGhlcndpc2UgcmV0dXJucyBhIHN0cmluZ1xuICAgICAgY29uc29sZS5sb2coXCJkZXN0aW5hdGlvbiBsYXRpdHVkZSB3aXRoIHBhcnN0RmxvYXRcIiwgZGVzdExhdCk7XG4gICAgICB2YXIgZGVzdExuZyA9IGRhdGEucmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvbi5sbmc7XG4gICAgICB2YXIgZGVzdExuZ0Nvb3JkID0gcGFyc2VGbG9hdChkZXN0TG5nKTtcbiAgICAgIHZhciBkZXN0TGF0TG5nID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhkZXN0TGF0Q29vcmQsIGRlc3RMbmdDb29yZCk7XG4gICAgICBjb25zb2xlLmxvZyhcImJvdGggdG9nZXRoZXI7IGFyZSB0aGVzZSBudW1iZXJzP1wiLCBkZXN0TGF0TG5nKTtcbiAgICAgIHZhciBob290ZXJzMm5kQXZlID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZygzNi4xNzQzNzA2LCAtODYuNzgyOTkzOTAwMDAwMDEpO1xuICAgICAgdmFyIGhvb3RlcnNMZWJhbm9uUGlrZSA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoMzYuMTg2MzMzNzAwMDAwMDEsIC04Ni42MzMxNDc5OTk5OTk5OSk7XG4gICAgICB2YXIgaG9vdGVyc0xhcmdvRHJpdmUgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjA4MTUxNCwgLTg2LjcwOTU0MTMpO1xuICAgICAgY29uc29sZS5sb2coXCJib3RoIHRvZ2V0aGVyIGFuZCB0aGUgMm5kIEF2ZSBIb290ZXJzXCIsIGRlc3RMYXRMbmcsIFwiMm5kIEF2ZVwiLCBob290ZXJzMm5kQXZlLCBcImFyZSB0aGVzZSBvYmplY3RzP1wiKTtcbiAgICAgIHZhciBkaXN0U2Vjb25kQXZlID0gZ29vZ2xlLm1hcHMuZ2VvbWV0cnkuc3BoZXJpY2FsLmNvbXB1dGVEaXN0YW5jZUJldHdlZW4oZGVzdExhdExuZywgaG9vdGVyczJuZEF2ZSk7XG4gICAgICB2YXIgZGlzdExlYmFub25QaWtlID0gZ29vZ2xlLm1hcHMuZ2VvbWV0cnkuc3BoZXJpY2FsLmNvbXB1dGVEaXN0YW5jZUJldHdlZW4oZGVzdExhdExuZywgaG9vdGVyc0xlYmFub25QaWtlKTtcbiAgICAgIHZhciBkaXN0TGFyZ29Ecml2ZSA9IGdvb2dsZS5tYXBzLmdlb21ldHJ5LnNwaGVyaWNhbC5jb21wdXRlRGlzdGFuY2VCZXR3ZWVuKGRlc3RMYXRMbmcsIGhvb3RlcnNMYXJnb0RyaXZlKTtcbiAgICAgIGhvb3RlcnNEaXN0YW5jZXMucHVzaChkaXN0TGFyZ29Ecml2ZSwgZGlzdExlYmFub25QaWtlLCBkaXN0U2Vjb25kQXZlKTtcbiAgICAgIHZhciBuZWFyZXN0SG9vdGVycyA9IE1hdGgubWluLmFwcGx5KE1hdGgsIGhvb3RlcnNEaXN0YW5jZXMpO1xuICAgICAgLyogdmFyIGhvb3RlcnNXYXlwb2ludCA9IGZ1bmN0aW9uICgpIHtcbiAgICAgIGlmIChuZWFyZXN0SG9vdGVycyA9PT0gZGlzdFNlY29uZEF2ZSkge1xuICAgICAgICByZXR1cm4gaG9vdGVyczJuZEF2ZTtcbiAgICAgIH0gZWxzZSBpZiAobmVhcmVzdEhvb3RlcnMgPT09IGRpc3RMYXJnb0RyaXZlKSB7XG4gICAgICAgIHJldHVybiBob290ZXJzTGFyZ29Ecml2ZTtcbiAgICAgIH0gZWxzZSBpZiAobmVhcmVzdEhvb3RlcnMgPT09IGRpc3RMZWJhbm9uUGlrZSkge1xuICAgICAgICByZXR1cm4gaG9vdGVyc0xlYmFub25QaWtlO1xuICAgICAgfVxuICAgIH07aG9vdGVyc1dheXBvaW50KCk7XG4vL21vdmluZyB0aGlzIG1hcmtlciBkb3duIHRvIGJlY29tZSB3YXlwdHNcbnZhciBob290ZXJzTWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICBwb3NpdGlvbjogaG9vdGVyczJuZEF2ZSxcbiAgICAgIG1hcDogbWFwLFxuICAgICAgaWNvbjogJ2h0dHA6Ly9lZHdpbmFjZXZlZG8uY29tL2RpcmVjdGlvbnNGcm9tL2ltZy9ob290ZXJzLW1hcmtlci5wbmcnXG4gIH0pOyovXG4gICAgfSk7XG4gIH1cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuICAvL2F1dG9jb21wbGV0ZSBmb3IgdGhlIHNlYXJjaCBib3hcbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG52YXIgcGFjX2lucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3doZXJlVG8nKTtcbihmdW5jdGlvbiBwYWNTZWxlY3RGaXJzdChpbnB1dCkge1xuICAvLyBzdG9yZSB0aGUgb3JpZ2luYWwgZXZlbnQgYmluZGluZyBmdW5jdGlvblxuICB2YXIgX2FkZEV2ZW50TGlzdGVuZXIgPSAoaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcikgPyBpbnB1dC5hZGRFdmVudExpc3RlbmVyIDogaW5wdXQuYXR0YWNoRXZlbnQ7XG5cbiAgZnVuY3Rpb24gYWRkRXZlbnRMaXN0ZW5lcldyYXBwZXIodHlwZSwgbGlzdGVuZXIpIHtcbiAgICAvLyBTaW11bGF0ZSBhICdkb3duIGFycm93JyBrZXlwcmVzcyBvbiBoaXR0aW5nICdyZXR1cm4nIHdoZW4gbm8gcGFjIHN1Z2dlc3Rpb24gaXMgc2VsZWN0ZWQsXG4gICAgLy8gYW5kIHRoZW4gdHJpZ2dlciB0aGUgb3JpZ2luYWwgbGlzdGVuZXIuXG4gICAgaWYgKHR5cGUgPT0gXCJrZXlkb3duXCIpIHtcbiAgICAgIHZhciBvcmlnX2xpc3RlbmVyID0gbGlzdGVuZXI7XG4gICAgICBsaXN0ZW5lciA9IGZ1bmN0aW9uIChldmVudCkge1xuICAgICAgICB2YXIgc3VnZ2VzdGlvbl9zZWxlY3RlZCA9ICQoXCIucGFjLWl0ZW0tc2VsZWN0ZWRcIikubGVuZ3RoID4gMDtcbiAgICAgICAgaWYgKGV2ZW50LndoaWNoID09IDEzICYmICFzdWdnZXN0aW9uX3NlbGVjdGVkKSB7XG4gICAgICAgICAgdmFyIHNpbXVsYXRlZF9kb3duYXJyb3cgPSAkLkV2ZW50KFwia2V5ZG93blwiLCB7XG4gICAgICAgICAgICBrZXlDb2RlOiA0MCxcbiAgICAgICAgICAgIHdoaWNoOiA0MFxuICAgICAgICAgIH0pO1xuICAgICAgICAgIG9yaWdfbGlzdGVuZXIuYXBwbHkoaW5wdXQsIFtzaW11bGF0ZWRfZG93bmFycm93XSk7XG4gICAgICAgIH1cbiAgICAgICAgb3JpZ19saXN0ZW5lci5hcHBseShpbnB1dCwgW2V2ZW50XSk7XG4gICAgICB9O1xuICAgIH1cbiAgICAvLyBhZGQgdGhlIG1vZGlmaWVkIGxpc3RlbmVyXG4gICAgX2FkZEV2ZW50TGlzdGVuZXIuYXBwbHkoaW5wdXQsIFt0eXBlLCBsaXN0ZW5lcl0pO1xuICB9XG4gIGlmIChpbnB1dC5hZGRFdmVudExpc3RlbmVyKVxuICAgIGlucHV0LmFkZEV2ZW50TGlzdGVuZXIgPSBhZGRFdmVudExpc3RlbmVyV3JhcHBlcjtcbiAgZWxzZSBpZiAoaW5wdXQuYXR0YWNoRXZlbnQpXG4gICAgaW5wdXQuYXR0YWNoRXZlbnQgPSBhZGRFdmVudExpc3RlbmVyV3JhcHBlcjtcbn0pKHBhY19pbnB1dCk7XG4kKGZ1bmN0aW9uICgpIHtcbiAgdmFyIGF1dG9jb21wbGV0ZSA9IG5ldyBnb29nbGUubWFwcy5wbGFjZXMuQXV0b2NvbXBsZXRlKHBhY19pbnB1dCk7XG59KTtcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuLy9kcmF3IHRoZSByb3V0ZSBvbiB0aGUgbWFwXG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuZnVuY3Rpb24gY2FsY1JvdXRlKHBvcywgZGVzdExhdExuZykge1xuICAvL3BsYWNpbmcgdGhlIG93bCwgdGhlc2UgbGluZXMgZnJvbSBoZXJlXG4gIHZhciBtYXJrZXJzID0gW107IC8vdGhpcyB3b3VsZCBoYXZlIGJlZW4gdXNlZCBpbiBhbiBhcnJheSBmb3IgdGhlIG5lYXJieSBob290ZXJzXG4gIHZhciBidG5XaGVyZVRvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2J0bldoZXJlVG8nKTtcbiAgZ29vZ2xlLm1hcHMuZXZlbnQuYWRkTGlzdGVuZXIoYnRuV2hlcmVUbywgJ2NsaWNrJywgZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgYWRkTWFya2VyKCk7XG4gIH0pO1xuICBjb25zb2xlLmxvZyhidG5XaGVyZVRvKVxuXG4gIGZ1bmN0aW9uIGFkZE1hcmtlcigpIHtcbiAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7IC8vbW92aW5nIHRoaXMgZG93biBjbG9zZXIgdG8gd2F5cG9pbnRzXG4gICAgICBwb3NpdGlvbjogaG9vdGVyczJuZEF2ZSxcbiAgICAgIG1hcDogbWFwLFxuICAgICAgaW1hZ2U6ICdodHRwOi8vZWR3aW5hY2V2ZWRvLmNvbS9kaXJlY3Rpb25zRnJvbS9pbWcvaG9vdGVycy1zYXVjZS5wbmcnXG4gICAgfSk7XG4gICAgbWFya2Vycy5wdXNoKG1hcmtlcik7IC8vdGhpcyB3b3VsZCBoYXZlIHB1c2hlZCB0aGUgbWFya2VycyBpbnRvIGFuYSBycmF5XG4gIH1cbiAgLy90byBoZXJlXG4gIHZhciB3aGVyZVRvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3doZXJlVG8nKS52YWx1ZTtcbiAgdmFyIGhvb3RlcnMybmRBdmUgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE3NDM3MDYsIC04Ni43ODI5OTM5MDAwMDAwMSk7XG4gIGNvbnNvbGUubG9nKCdob290ZXJzMm5kQXZlJywgaG9vdGVyczJuZEF2ZSk7XG4gIHZhciB3YXlwdHMgPSBbe1xuICAgIGxvY2F0aW9uOiBob290ZXJzMm5kQXZlLCAvL3RoaXMgaXMgdW5kZWZpbmVkXG4gICAgc3RvcG92ZXI6IHRydWVcbiAgfV07XG4gIGRpcmVjdGlvbnNEaXNwbGF5ID0gbmV3IGdvb2dsZS5tYXBzLkRpcmVjdGlvbnNSZW5kZXJlcih7XG4gICAgc3VwcHJlc3NNYXJrZXJzOiB0cnVlLFxuICB9KTtcbiAgZGlyZWN0aW9uc0Rpc3BsYXkuc2V0TWFwKG1hcCk7XG4gIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XG4gICAgdmFyIHBvcyA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcocG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLCBwb3NpdGlvbi5jb29yZHMubG9uZ2l0dWRlKTtcbiAgICB2YXIgbWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICBwb3NpdGlvbjogaG9vdGVyczJuZEF2ZSAvKndheXB0cyovICxcbiAgICAgIG1hcDogbWFwLFxuICAgICAgaWNvbjogJ2h0dHA6Ly9lZHdpbmFjZXZlZG8uY29tL2RpcmVjdGlvbnNGcm9tL2ltZy9ob290ZXJzLW1hcmtlci5wbmcnXG4gICAgfSk7XG4gICAgdmFyIHJlcXVlc3QgPSB7XG4gICAgICBvcmlnaW46IHBvcywgLy9mcm9tIGdlb2xvY2F0aW9uXG4gICAgICBkZXN0aW5hdGlvbjogd2hlcmVUbywgLy9mcm9tIGlucHV0LnZhbHVlIG9mICN3aGVyZVRvXG4gICAgICB3YXlwb2ludHM6IHdheXB0cyxcbiAgICAgIC8vcGxhY2VJZDogJ0NoSUpPd0U3X0dUdHdva1JGcTB1T3dMU0U5ZydcbiAgICAgIG9wdGltaXplV2F5cG9pbnRzOiBmYWxzZSxcbiAgICAgIHRyYXZlbE1vZGU6IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuRFJJVklOR1xuICAgIH07XG4gICAgY29uc29sZS5sb2coJ3dheXB0cycsIHdheXB0cyk7XG4gICAgY29uc29sZS5sb2coJ21hcmtlcicsIG1hcmtlcik7XG4gICAgY29uc29sZS5sb2coJ21hcCcsIG1hcCk7XG4gICAgY29uc29sZS5sb2coJ3BvcycsIHBvcyk7XG4gICAgY29uc29sZS5sb2coJ3doZXJlVG8sIHRoaXMgdGltZSBpbmNsdWRpbmcgdGhlIGlucHV0LnZhbHVlJywgd2hlcmVUbyk7XG4gICAgZGlyZWN0aW9uc1NlcnZpY2Uucm91dGUocmVxdWVzdCwgZnVuY3Rpb24gKHJlc3BvbnNlLCBzdGF0dXMpIHtcbiAgICAgIGlmIChzdGF0dXMgPT0gZ29vZ2xlLm1hcHMuRGlyZWN0aW9uc1N0YXR1cy5PSykge1xuICAgICAgICBkaXJlY3Rpb25zRGlzcGxheS5zZXREaXJlY3Rpb25zKHJlc3BvbnNlKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfSk7XG59XG5nb29nbGUubWFwcy5ldmVudC5hZGREb21MaXN0ZW5lcih3aW5kb3csICdsb2FkJywgaW5pdGlhbGl6ZSwgY2FsY1JvdXRlLCBjbG9zZXN0SG9vdGVycyk7XG4iXX0=
