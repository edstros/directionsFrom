'use strict';

var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;
var pos;
var destLatLng;
////////////////////////
//start the party
////////////////////////
function initialize() {
  var mapCanvas = document.getElementById('map-canvas'); //div in the html
  var mapOptions = {
    center: new google.maps.LatLng(36.1667, -86.7833), //NashVegas, TN
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    scrollwheel: false };
  map = new google.maps.Map(mapCanvas, mapOptions);
  console.log(map); //this works, produces map object
  // Try HTML5 geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      var infowindow = new google.maps.InfoWindow({
        map: map,
        position: pos,
        pixelOffset: new google.maps.Size(0, -20),
        content: 'Start here'
      });
      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        animation: google.maps.Animation.DROP,
        title: 'This is your geolocation'
      });
      //copied the next six lines from google, not gonna lie
      google.maps.event.addListener(marker, 'click', toggleBounce);

      function toggleBounce() {
        if (marker.getAnimation() !== null) {
          marker.setAnimation(null);
        } else {
          marker.setAnimation(google.maps.Animation.BOUNCE);
        }
      }
      google.maps.event.addListener(marker, 'click', function () {
        infowindow.open(map, marker); //this should be redone in the infobox class
      });
      map.setCenter(pos);
      console.log(map);
      //refactored code from weather app
      var btnWhereTo = document.querySelector('#btnWhereTo'); //creates the button element using the id from the button input
      btnWhereTo.onclick = function () {
        closestHooters();
        calcRoute(pos);
      };
      //adds the calcroute within geolocation because geolocation is the starting point
    }, function () {
      handleNoGeolocation(true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(false);
  }
}
//////////////////////////////
//destLatLng returns a string,
//which breaks the app
//////////////////////////////
function closestHooters() {

  var input = document.querySelector('#whereTo');
  var whereTo = input.value;
  var destinationAddress = whereTo.split(' ').join('+');
  var MAPS_URL = 'https://maps.googleapis.com/maps/api/geocode/json?address=';

  var hootersWaypoint;
  $.get(MAPS_URL + destinationAddress, function (data) {
    console.log(data); //now it sees this
    var hootersDistances = [];
    var destLat = data.results[0].geometry.location.lat;
    var destLatCoord = parseFloat(destLat); //otherwise returns a string
    console.log('destination latitude with parstFloat', destLat);
    var destLng = data.results[0].geometry.location.lng;
    var destLngCoord = parseFloat(destLng);
    var destLatLng = new google.maps.LatLng(destLatCoord, destLngCoord);
    console.log('both together', destLatLng);
    var hooters2ndAve = new google.maps.LatLng(36.1618914, -86.789464);
    var hootersLebanonPike = new google.maps.LatLng(36.18633370000001, -86.63314799999999);
    var hootersLargoDrive = new google.maps.LatLng(36.081514, -86.7095413);
    console.log('both together and the 2nd Ave Hooters', destLatLng, '2nd Ave', hooters2ndAve);
    var distSecondAve = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hooters2ndAve);
    var distLebanonPike = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hootersLebanonPike);
    var distLargoDrive = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hootersLargoDrive);
    hootersDistances.push(distLargoDrive, distLebanonPike, distSecondAve);
    var nearestHooters = Math.min.apply(Math, hootersDistances);
    hootersWaypoint = function () {
      if (nearestHooters === distSecondAve) {
        return hooters2ndAve;
      } else if (nearestHooters === distLargoDrive) {
        return hootersLargoDrive;
      } else if (nearestHooters === distLebanonPike) {
        return hootersLebanonPike;
      }
    };
  });
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Aw snap! Something went wrong with the Geolocation service. Sorry?';
  } else {
    var content = 'Aw, snap! Your browser doesn\'t support geolocation.';
  }
  var options = {
    map: map,
    position: new google.maps.LatLng(36.1667, 86.7833),
    content: content
  };
  var infowindow = new google.maps.InfoWindow(options);
  map.setCenter(options.position);
}
//////////////////////////////////
//autocomplete for the search box
/////////////////////////////////
var pac_input = document.getElementById('whereTo');
(function pacSelectFirst(input) {
  // store the original event binding function
  var _addEventListener = input.addEventListener ? input.addEventListener : input.attachEvent;

  function addEventListenerWrapper(type, listener) {
    // Simulate a 'down arrow' keypress on hitting 'return' when no pac suggestion is selected,
    // and then trigger the original listener.
    if (type == 'keydown') {
      var orig_listener = listener;
      listener = function (event) {
        var suggestion_selected = $('.pac-item-selected').length > 0;
        if (event.which == 13 && !suggestion_selected) {
          var simulated_downarrow = $.Event('keydown', {
            keyCode: 40,
            which: 40
          });
          orig_listener.apply(input, [simulated_downarrow]);
        }
        orig_listener.apply(input, [event]);
      };
    }
    // add the modified listener
    _addEventListener.apply(input, [type, listener]);
  }
  if (input.addEventListener) input.addEventListener = addEventListenerWrapper;else if (input.attachEvent) input.attachEvent = addEventListenerWrapper;
})(pac_input);
$(function () {
  var autocomplete = new google.maps.places.Autocomplete(pac_input);
});
//////////////////////////////
//draw the route on the map
/////////////////////////////
function calcRoute(pos, destLatLng, hootersWaypoint) {
  var waypts = [{
    location: hootersWaypoint, //this is undefined
    stopover: true
  }];
  var request = {
    origin: pos, //from geolocation
    destination: whereTo, //from input.value of #whereTo
    waypoints: waypts,
    //placeId: 'ChIJOwE7_GTtwokRFq0uOwLSE9g'
    optimizeWaypoints: false,
    travelMode: google.maps.TravelMode.DRIVING
  };
  console.log(waypts);
  console.log(map);
  console.log(pos);
  console.log(whereTo);

  directionsService.route(request, function (response, status) {
    if (status == google.maps.DirectionsStatus.OK) {
      directionsDisplay.setDirections(response);
    }
  });
}
google.maps.event.addDomListener(window, 'load', initialize, calcRoute);
//# sourceMappingURL=data:application/json;base64,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LGVBQWU7QUFDekIsWUFBUSxFQUFFLElBQUk7R0FDZixDQUFDLENBQUM7QUFDSCxNQUFJLE9BQU8sR0FBRztBQUNaLFVBQU0sRUFBRSxHQUFHO0FBQ1gsZUFBVyxFQUFFLE9BQU87QUFDcEIsYUFBUyxFQUFFLE1BQU07O0FBRWpCLHFCQUFpQixFQUFFLEtBQUs7QUFDeEIsY0FBVSxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU87R0FDM0MsQ0FBQztBQUNGLFNBQU8sQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7QUFDcEIsU0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUNqQixTQUFPLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ2pCLFNBQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7O0FBRXJCLG1CQUFpQixDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsVUFBVSxRQUFRLEVBQUUsTUFBTSxFQUFFO0FBQzNELFFBQUksTUFBTSxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsRUFBRSxFQUFFO0FBQzdDLHVCQUFpQixDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQztLQUMzQztHQUNGLENBQUMsQ0FBQztDQUNKO0FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDIiwiZmlsZSI6InNyYy9qcy9tYWluLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIGRpcmVjdGlvbnNEaXNwbGF5O1xudmFyIGRpcmVjdGlvbnNTZXJ2aWNlID0gbmV3IGdvb2dsZS5tYXBzLkRpcmVjdGlvbnNTZXJ2aWNlKCk7XG52YXIgbWFwO1xudmFyIHBvcztcbnZhciBkZXN0TGF0TG5nO1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vL3N0YXJ0IHRoZSBwYXJ0eVxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5mdW5jdGlvbiBpbml0aWFsaXplKCkge1xuICAgIHZhciBtYXBDYW52YXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWFwLWNhbnZhcycpOyAvL2RpdiBpbiB0aGUgaHRtbFxuICAgIHZhciBtYXBPcHRpb25zID0ge1xuICAgICAgY2VudGVyOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE2NjcsIC04Ni43ODMzKSwgLy9OYXNoVmVnYXMsIFROXG4gICAgICB6b29tOiAxNSxcbiAgICAgIG1hcFR5cGVJZDogZ29vZ2xlLm1hcHMuTWFwVHlwZUlkLlJPQURNQVAsXG4gICAgICBzY3JvbGx3aGVlbDogZmFsc2UsXG4gICAgfTtcbiAgICBtYXAgPSBuZXcgZ29vZ2xlLm1hcHMuTWFwKG1hcENhbnZhcywgbWFwT3B0aW9ucyk7XG4gICAgY29uc29sZS5sb2cobWFwKTsgLy90aGlzIHdvcmtzLCBwcm9kdWNlcyBtYXAgb2JqZWN0XG4gICAgLy8gVHJ5IEhUTUw1IGdlb2xvY2F0aW9uXG4gICAgaWYgKG5hdmlnYXRvci5nZW9sb2NhdGlvbikge1xuICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcbiAgICAgICAgcG9zID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsIHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGUpO1xuICAgICAgICB2YXIgaW5mb3dpbmRvdyA9IG5ldyBnb29nbGUubWFwcy5JbmZvV2luZG93KHtcbiAgICAgICAgICBtYXA6IG1hcCxcbiAgICAgICAgICBwb3NpdGlvbjogcG9zLFxuICAgICAgICAgIHBpeGVsT2Zmc2V0OiBuZXcgZ29vZ2xlLm1hcHMuU2l6ZSgwLCAtMjApLFxuICAgICAgICAgIGNvbnRlbnQ6ICdTdGFydCBoZXJlJ1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xuICAgICAgICAgIHBvc2l0aW9uOiBwb3MsXG4gICAgICAgICAgbWFwOiBtYXAsXG4gICAgICAgICAgYW5pbWF0aW9uOiBnb29nbGUubWFwcy5BbmltYXRpb24uRFJPUCxcbiAgICAgICAgICB0aXRsZTogJ1RoaXMgaXMgeW91ciBnZW9sb2NhdGlvbidcbiAgICAgICAgfSk7XG4gICAgICAgIC8vY29waWVkIHRoZSBuZXh0IHNpeCBsaW5lcyBmcm9tIGdvb2dsZSwgbm90IGdvbm5hIGxpZVxuICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdjbGljaycsIHRvZ2dsZUJvdW5jZSk7XG5cbiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlQm91bmNlKCkge1xuICAgICAgICAgIGlmIChtYXJrZXIuZ2V0QW5pbWF0aW9uKCkgIT09IG51bGwpIHtcbiAgICAgICAgICAgIG1hcmtlci5zZXRBbmltYXRpb24obnVsbCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1hcmtlci5zZXRBbmltYXRpb24oZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkJPVU5DRSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcmtlciwgJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGluZm93aW5kb3cub3BlbihtYXAsIG1hcmtlcik7IC8vdGhpcyBzaG91bGQgYmUgcmVkb25lIGluIHRoZSBpbmZvYm94IGNsYXNzXG4gICAgICAgIH0pO1xuICAgICAgICBtYXAuc2V0Q2VudGVyKHBvcyk7XG4gICAgICAgIGNvbnNvbGUubG9nKG1hcCk7XG4gICAgICAgIC8vcmVmYWN0b3JlZCBjb2RlIGZyb20gd2VhdGhlciBhcHBcbiAgICAgICAgdmFyIGJ0bldoZXJlVG8gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjYnRuV2hlcmVUbycpOyAvL2NyZWF0ZXMgdGhlIGJ1dHRvbiBlbGVtZW50IHVzaW5nIHRoZSBpZCBmcm9tIHRoZSBidXR0b24gaW5wdXRcbiAgICAgICAgYnRuV2hlcmVUby5vbmNsaWNrID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNsb3Nlc3RIb290ZXJzKCk7XG4gICAgICAgICAgY2FsY1JvdXRlKHBvcyk7XG4gICAgICAgIH07XG4gICAgICAgIC8vYWRkcyB0aGUgY2FsY3JvdXRlIHdpdGhpbiBnZW9sb2NhdGlvbiBiZWNhdXNlIGdlb2xvY2F0aW9uIGlzIHRoZSBzdGFydGluZyBwb2ludFxuICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICBoYW5kbGVOb0dlb2xvY2F0aW9uKHRydWUpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IEdlb2xvY2F0aW9uXG4gICAgICBoYW5kbGVOb0dlb2xvY2F0aW9uKGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vZGVzdExhdExuZyByZXR1cm5zIGEgc3RyaW5nLFxuICAvL3doaWNoIGJyZWFrcyB0aGUgYXBwXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuZnVuY3Rpb24gY2xvc2VzdEhvb3RlcnMoKSB7XG5cbiAgdmFyIGlucHV0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3doZXJlVG8nKTtcbiAgdmFyIHdoZXJlVG8gPSBpbnB1dC52YWx1ZTtcbiAgdmFyIGRlc3RpbmF0aW9uQWRkcmVzcyA9IHdoZXJlVG8uc3BsaXQoJyAnKS5qb2luKCcrJyk7XG4gIHZhciBNQVBTX1VSTCA9ICdodHRwczovL21hcHMuZ29vZ2xlYXBpcy5jb20vbWFwcy9hcGkvZ2VvY29kZS9qc29uP2FkZHJlc3M9JztcblxuICB2YXIgaG9vdGVyc1dheXBvaW50O1xuICAkLmdldChNQVBTX1VSTCArIGRlc3RpbmF0aW9uQWRkcmVzcywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICBjb25zb2xlLmxvZyhkYXRhKTsgLy9ub3cgaXQgc2VlcyB0aGlzXG4gICAgdmFyIGhvb3RlcnNEaXN0YW5jZXMgPSBbXTtcbiAgICB2YXIgZGVzdExhdCA9IGRhdGEucmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvbi5sYXQ7XG4gICAgdmFyIGRlc3RMYXRDb29yZCA9IHBhcnNlRmxvYXQoZGVzdExhdCk7IC8vb3RoZXJ3aXNlIHJldHVybnMgYSBzdHJpbmdcbiAgICBjb25zb2xlLmxvZyhcImRlc3RpbmF0aW9uIGxhdGl0dWRlIHdpdGggcGFyc3RGbG9hdFwiLCBkZXN0TGF0KTtcbiAgICB2YXIgZGVzdExuZyA9IGRhdGEucmVzdWx0c1swXS5nZW9tZXRyeS5sb2NhdGlvbi5sbmc7XG4gICAgdmFyIGRlc3RMbmdDb29yZCA9IHBhcnNlRmxvYXQoZGVzdExuZyk7XG4gICAgdmFyIGRlc3RMYXRMbmcgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKGRlc3RMYXRDb29yZCwgZGVzdExuZ0Nvb3JkKTtcbiAgICBjb25zb2xlLmxvZyhcImJvdGggdG9nZXRoZXJcIiwgZGVzdExhdExuZyk7XG4gICAgdmFyIGhvb3RlcnMybmRBdmUgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE2MTg5MTQsIC04Ni43ODk0NjQpO1xuICAgIHZhciBob290ZXJzTGViYW5vblBpa2UgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE4NjMzMzcwMDAwMDAxLCAtODYuNjMzMTQ3OTk5OTk5OTkpO1xuICAgIHZhciBob290ZXJzTGFyZ29Ecml2ZSA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoMzYuMDgxNTE0LCAtODYuNzA5NTQxMyk7XG4gICAgY29uc29sZS5sb2coXCJib3RoIHRvZ2V0aGVyIGFuZCB0aGUgMm5kIEF2ZSBIb290ZXJzXCIsIGRlc3RMYXRMbmcsIFwiMm5kIEF2ZVwiLCBob290ZXJzMm5kQXZlKTtcbiAgICB2YXIgZGlzdFNlY29uZEF2ZSA9IGdvb2dsZS5tYXBzLmdlb21ldHJ5LnNwaGVyaWNhbC5jb21wdXRlRGlzdGFuY2VCZXR3ZWVuKGRlc3RMYXRMbmcsIGhvb3RlcnMybmRBdmUpO1xuICAgIHZhciBkaXN0TGViYW5vblBpa2UgPSBnb29nbGUubWFwcy5nZW9tZXRyeS5zcGhlcmljYWwuY29tcHV0ZURpc3RhbmNlQmV0d2VlbihkZXN0TGF0TG5nLCBob290ZXJzTGViYW5vblBpa2UpO1xuICAgIHZhciBkaXN0TGFyZ29Ecml2ZSA9IGdvb2dsZS5tYXBzLmdlb21ldHJ5LnNwaGVyaWNhbC5jb21wdXRlRGlzdGFuY2VCZXR3ZWVuKGRlc3RMYXRMbmcsIGhvb3RlcnNMYXJnb0RyaXZlKTtcbiAgICBob290ZXJzRGlzdGFuY2VzLnB1c2goZGlzdExhcmdvRHJpdmUsIGRpc3RMZWJhbm9uUGlrZSwgZGlzdFNlY29uZEF2ZSk7XG4gICAgdmFyIG5lYXJlc3RIb290ZXJzID0gTWF0aC5taW4uYXBwbHkoTWF0aCwgaG9vdGVyc0Rpc3RhbmNlcyk7XG4gICAgaG9vdGVyc1dheXBvaW50ID0gZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKG5lYXJlc3RIb290ZXJzID09PSBkaXN0U2Vjb25kQXZlKSB7XG4gICAgICAgIHJldHVybiBob290ZXJzMm5kQXZlXG4gICAgICB9IGVsc2UgaWYgKG5lYXJlc3RIb290ZXJzID09PSBkaXN0TGFyZ29Ecml2ZSkge1xuICAgICAgICByZXR1cm4gaG9vdGVyc0xhcmdvRHJpdmVcbiAgICAgIH0gZWxzZSBpZiAobmVhcmVzdEhvb3RlcnMgPT09IGRpc3RMZWJhbm9uUGlrZSkge1xuICAgICAgICByZXR1cm4gaG9vdGVyc0xlYmFub25QaWtlXG4gICAgICB9XG4gICAgfVxuICB9KTtcbn1cblxuZnVuY3Rpb24gaGFuZGxlTm9HZW9sb2NhdGlvbihlcnJvckZsYWcpIHtcbiAgICBpZiAoZXJyb3JGbGFnKSB7XG4gICAgICB2YXIgY29udGVudCA9ICdBdyBzbmFwISBTb21ldGhpbmcgd2VudCB3cm9uZyB3aXRoIHRoZSBHZW9sb2NhdGlvbiBzZXJ2aWNlLiBTb3JyeT8nO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YXIgY29udGVudCA9ICdBdywgc25hcCEgWW91ciBicm93c2VyIGRvZXNuXFwndCBzdXBwb3J0IGdlb2xvY2F0aW9uLic7XG4gICAgfVxuICAgIHZhciBvcHRpb25zID0ge1xuICAgICAgbWFwOiBtYXAsXG4gICAgICBwb3NpdGlvbjogbmV3IGdvb2dsZS5tYXBzLkxhdExuZygzNi4xNjY3LCA4Ni43ODMzKSxcbiAgICAgIGNvbnRlbnQ6IGNvbnRlbnRcbiAgICB9O1xuICAgIHZhciBpbmZvd2luZG93ID0gbmV3IGdvb2dsZS5tYXBzLkluZm9XaW5kb3cob3B0aW9ucyk7XG4gICAgbWFwLnNldENlbnRlcihvcHRpb25zLnBvc2l0aW9uKTtcbiAgfVxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vYXV0b2NvbXBsZXRlIGZvciB0aGUgc2VhcmNoIGJveFxuICAvLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbnZhciBwYWNfaW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnd2hlcmVUbycpO1xuKGZ1bmN0aW9uIHBhY1NlbGVjdEZpcnN0KGlucHV0KSB7XG4gIC8vIHN0b3JlIHRoZSBvcmlnaW5hbCBldmVudCBiaW5kaW5nIGZ1bmN0aW9uXG4gIHZhciBfYWRkRXZlbnRMaXN0ZW5lciA9IChpbnB1dC5hZGRFdmVudExpc3RlbmVyKSA/IGlucHV0LmFkZEV2ZW50TGlzdGVuZXIgOiBpbnB1dC5hdHRhY2hFdmVudDtcblxuICBmdW5jdGlvbiBhZGRFdmVudExpc3RlbmVyV3JhcHBlcih0eXBlLCBsaXN0ZW5lcikge1xuICAgIC8vIFNpbXVsYXRlIGEgJ2Rvd24gYXJyb3cnIGtleXByZXNzIG9uIGhpdHRpbmcgJ3JldHVybicgd2hlbiBubyBwYWMgc3VnZ2VzdGlvbiBpcyBzZWxlY3RlZCxcbiAgICAvLyBhbmQgdGhlbiB0cmlnZ2VyIHRoZSBvcmlnaW5hbCBsaXN0ZW5lci5cbiAgICBpZiAodHlwZSA9PSBcImtleWRvd25cIikge1xuICAgICAgdmFyIG9yaWdfbGlzdGVuZXIgPSBsaXN0ZW5lcjtcbiAgICAgIGxpc3RlbmVyID0gZnVuY3Rpb24gKGV2ZW50KSB7XG4gICAgICAgIHZhciBzdWdnZXN0aW9uX3NlbGVjdGVkID0gJChcIi5wYWMtaXRlbS1zZWxlY3RlZFwiKS5sZW5ndGggPiAwO1xuICAgICAgICBpZiAoZXZlbnQud2hpY2ggPT0gMTMgJiYgIXN1Z2dlc3Rpb25fc2VsZWN0ZWQpIHtcbiAgICAgICAgICB2YXIgc2ltdWxhdGVkX2Rvd25hcnJvdyA9ICQuRXZlbnQoXCJrZXlkb3duXCIsIHtcbiAgICAgICAgICAgIGtleUNvZGU6IDQwLFxuICAgICAgICAgICAgd2hpY2g6IDQwXG4gICAgICAgICAgfSk7XG4gICAgICAgICAgb3JpZ19saXN0ZW5lci5hcHBseShpbnB1dCwgW3NpbXVsYXRlZF9kb3duYXJyb3ddKTtcbiAgICAgICAgfVxuICAgICAgICBvcmlnX2xpc3RlbmVyLmFwcGx5KGlucHV0LCBbZXZlbnRdKTtcbiAgICAgIH07XG4gICAgfVxuICAgIC8vIGFkZCB0aGUgbW9kaWZpZWQgbGlzdGVuZXJcbiAgICBfYWRkRXZlbnRMaXN0ZW5lci5hcHBseShpbnB1dCwgW3R5cGUsIGxpc3RlbmVyXSk7XG4gIH1cbiAgaWYgKGlucHV0LmFkZEV2ZW50TGlzdGVuZXIpXG4gICAgaW5wdXQuYWRkRXZlbnRMaXN0ZW5lciA9IGFkZEV2ZW50TGlzdGVuZXJXcmFwcGVyO1xuICBlbHNlIGlmIChpbnB1dC5hdHRhY2hFdmVudClcbiAgICBpbnB1dC5hdHRhY2hFdmVudCA9IGFkZEV2ZW50TGlzdGVuZXJXcmFwcGVyO1xufSkocGFjX2lucHV0KTtcbiQoZnVuY3Rpb24gKCkge1xuICB2YXIgYXV0b2NvbXBsZXRlID0gbmV3IGdvb2dsZS5tYXBzLnBsYWNlcy5BdXRvY29tcGxldGUocGFjX2lucHV0KTtcbn0pO1xuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4vL2RyYXcgdGhlIHJvdXRlIG9uIHRoZSBtYXBcbi8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG5mdW5jdGlvbiBjYWxjUm91dGUocG9zLCBkZXN0TGF0TG5nLCBob290ZXJzV2F5cG9pbnQpIHtcbiAgdmFyIHdheXB0cyA9IFt7XG4gICAgbG9jYXRpb246IGhvb3RlcnNXYXlwb2ludCwgLy90aGlzIGlzIHVuZGVmaW5lZFxuICAgIHN0b3BvdmVyOiB0cnVlXG4gIH1dO1xuICB2YXIgcmVxdWVzdCA9IHtcbiAgICBvcmlnaW46IHBvcywgLy9mcm9tIGdlb2xvY2F0aW9uXG4gICAgZGVzdGluYXRpb246IHdoZXJlVG8sIC8vZnJvbSBpbnB1dC52YWx1ZSBvZiAjd2hlcmVUb1xuICAgIHdheXBvaW50czogd2F5cHRzLFxuICAgIC8vcGxhY2VJZDogJ0NoSUpPd0U3X0dUdHdva1JGcTB1T3dMU0U5ZydcbiAgICBvcHRpbWl6ZVdheXBvaW50czogZmFsc2UsXG4gICAgdHJhdmVsTW9kZTogZ29vZ2xlLm1hcHMuVHJhdmVsTW9kZS5EUklWSU5HXG4gIH07XG4gIGNvbnNvbGUubG9nKHdheXB0cyk7XG4gIGNvbnNvbGUubG9nKG1hcCk7XG4gIGNvbnNvbGUubG9nKHBvcyk7XG4gIGNvbnNvbGUubG9nKHdoZXJlVG8pO1xuXG4gIGRpcmVjdGlvbnNTZXJ2aWNlLnJvdXRlKHJlcXVlc3QsIGZ1bmN0aW9uIChyZXNwb25zZSwgc3RhdHVzKSB7XG4gICAgaWYgKHN0YXR1cyA9PSBnb29nbGUubWFwcy5EaXJlY3Rpb25zU3RhdHVzLk9LKSB7XG4gICAgICBkaXJlY3Rpb25zRGlzcGxheS5zZXREaXJlY3Rpb25zKHJlc3BvbnNlKTtcbiAgICB9XG4gIH0pO1xufVxuZ29vZ2xlLm1hcHMuZXZlbnQuYWRkRG9tTGlzdGVuZXIod2luZG93LCAnbG9hZCcsIGluaXRpYWxpemUsIGNhbGNSb3V0ZSk7XG4iXX0=