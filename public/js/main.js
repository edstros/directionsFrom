'use strict';

var directionsDisplay;
var directionsService = new google.maps.DirectionsService();
var map;
var pos;
var destLatLng;
////////////////////////
//start the party
////////////////////////
function initialize() {
  var mapCanvas = document.getElementById('map-canvas'); //div in the html
  var mapOptions = {
    center: new google.maps.LatLng(36.1667, -86.7833), //NashVegas, TN
    zoom: 15,
    mapTypeId: google.maps.MapTypeId.ROADMAP,
    scrollwheel: false };
  map = new google.maps.Map(mapCanvas, mapOptions);
  console.log('map', map); //this works, produces map object
  // Try HTML5 geolocation
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
      var infowindow = new google.maps.InfoWindow({
        map: map,
        position: pos,
        pixelOffset: new google.maps.Size(0, -20),
        content: 'Start here'
      });
      var marker = new google.maps.Marker({
        position: pos,
        map: map,
        animation: google.maps.Animation.DROP,
        title: 'This is your geolocation'
      });
      //copied the next six lines from google, not gonna lie
      google.maps.event.addListener(marker, 'click', toggleBounce);

      function toggleBounce() {
        if (marker.getAnimation() !== null) {
          marker.setAnimation(null);
        } else {
          marker.setAnimation(google.maps.Animation.BOUNCE);
        }
      }
      google.maps.event.addListener(marker, 'click', function () {
        infowindow.open(map, marker); //this should be redone in the infobox class
      });
      map.setCenter(pos);
      console.log('map inside the geolocation function', map);
      //refactored code from weather app
      var btnWhereTo = document.querySelector('#btnWhereTo'); //creates the button element using the id from the button input
      btnWhereTo.onclick = function () {
        closestHooters();
        calcRoute(pos);
      };
      //adds the calcroute within geolocation because geolocation is the starting point
    }, function () {
      handleNoGeolocation(true);
    });
  } else {
    // Browser doesn't support Geolocation
    handleNoGeolocation(false);
  }
}
//////////////////////////////
//destLatLng returns a string,
//which breaks the app
//////////////////////////////

function closestHooters() {
  var whereTo = document.querySelector('#whereTo').value.split(' ').join('+');
  var MAPS_URL = 'https://maps.googleapis.com/maps/api/geocode/json?address=';

  $.get(MAPS_URL + whereTo, function (data) {
    console.log('data', data); //now it sees this
    var hootersDistances = [];
    var destLat = data.results[0].geometry.location.lat;
    var destLatCoord = parseFloat(destLat); //otherwise returns a string
    console.log('destination latitude with parstFloat', destLat);
    var destLng = data.results[0].geometry.location.lng;
    var destLngCoord = parseFloat(destLng);
    var destLatLng = new google.maps.LatLng(destLatCoord, destLngCoord);
    console.log('both together; are these numbers?', destLatLng);
    var hooters2ndAve = new google.maps.LatLng(36.1618914, -86.789464);
    var hootersLebanonPike = new google.maps.LatLng(36.18633370000001, -86.63314799999999);
    var hootersLargoDrive = new google.maps.LatLng(36.081514, -86.7095413);
    console.log('both together and the 2nd Ave Hooters', destLatLng, '2nd Ave', hooters2ndAve, 'are these objects?');
    var distSecondAve = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hooters2ndAve);
    var distLebanonPike = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hootersLebanonPike);
    var distLargoDrive = google.maps.geometry.spherical.computeDistanceBetween(destLatLng, hootersLargoDrive);
    hootersDistances.push(distLargoDrive, distLebanonPike, distSecondAve);
    var nearestHooters = Math.min.apply(Math, hootersDistances);
    var hootersWaypoint = function hootersWaypoint() {
      if (nearestHooters === distSecondAve) {
        return hooters2ndAve;
      } else if (nearestHooters === distLargoDrive) {
        return hootersLargoDrive;
      } else if (nearestHooters === distLebanonPike) {
        return hootersLebanonPike;
      }
    };hootersWaypoint();
    var hootersMarker = new google.maps.Marker({
      position: hooters2ndAve,
      map: map,
      icon: 'http://edwinacevedo.com/directionsFrom/img/hooters-marker.png'
    });
  });
}

function handleNoGeolocation(errorFlag) {
  if (errorFlag) {
    var content = 'Aw snap! Something went wrong with the Geolocation service. Sorry?';
  } else {
    var content = 'Aw, snap! Your browser doesn\'t support geolocation.';
  }
  var options = {
    map: map,
    position: new google.maps.LatLng(36.1667, 86.7833),
    content: content
  };
  var infowindow = new google.maps.InfoWindow(options);
  map.setCenter(options.position);
}
//////////////////////////////////
//autocomplete for the search box
/////////////////////////////////
var pac_input = document.getElementById('whereTo');
(function pacSelectFirst(input) {
  // store the original event binding function
  var _addEventListener = input.addEventListener ? input.addEventListener : input.attachEvent;

  function addEventListenerWrapper(type, listener) {
    // Simulate a 'down arrow' keypress on hitting 'return' when no pac suggestion is selected,
    // and then trigger the original listener.
    if (type == 'keydown') {
      var orig_listener = listener;
      listener = function (event) {
        var suggestion_selected = $('.pac-item-selected').length > 0;
        if (event.which == 13 && !suggestion_selected) {
          var simulated_downarrow = $.Event('keydown', {
            keyCode: 40,
            which: 40
          });
          orig_listener.apply(input, [simulated_downarrow]);
        }
        orig_listener.apply(input, [event]);
      };
    }
    // add the modified listener
    _addEventListener.apply(input, [type, listener]);
  }
  if (input.addEventListener) input.addEventListener = addEventListenerWrapper;else if (input.attachEvent) input.attachEvent = addEventListenerWrapper;
})(pac_input);
$(function () {
  var autocomplete = new google.maps.places.Autocomplete(pac_input);
});
//////////////////////////////
//draw the route on the map
/////////////////////////////
function calcRoute(pos, destLatLng, hootersWaypoint) {
  console.log('closestHooters', closestHooters);

  //placing the owl, these lines from here
  var markers = [];
  google.maps.event.addListener(map, 'click', function (event) {
    addMarker(event.latLng);
  });
  function addMarker(waypts) {
    var marker = new google.maps.Marker({
      position: waypts,
      map: map,
      image: 'http://edwinacevedo.com/directionsFrom/img/hooters-marker.png'
    });
    markers.push(marker);
  }

  //to here

  var whereTo = document.querySelector('#whereTo').value;
  var hooters2ndAve = new google.maps.LatLng(36.1618914, -86.789464);
  var waypts = [{
    location: hooters2ndAve, //this is undefined
    stopover: true
  }];
  directionsDisplay = new google.maps.DirectionsRenderer();
  directionsDisplay.setMap(map);
  navigator.geolocation.getCurrentPosition(function (position) {
    var pos = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
    var request = {
      origin: pos, //from geolocation
      destination: whereTo, //from input.value of #whereTo
      waypoints: waypts,
      //placeId: 'ChIJOwE7_GTtwokRFq0uOwLSE9g'
      optimizeWaypoints: false,
      travelMode: google.maps.TravelMode.DRIVING
    };
    console.log('waypts', waypts);
    console.log('map', map);
    console.log('pos', pos);
    console.log('whereTo, this time including the input.value', whereTo);

    directionsService.route(request, function (response, status) {
      if (status == google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
      }
    });
  });
}
google.maps.event.addDomListener(window, 'load', initialize, calcRoute, closestHooters);
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9qcy9tYWluLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSSxpQkFBaUIsQ0FBQztBQUN0QixJQUFJLGlCQUFpQixHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsRUFBRSxDQUFDO0FBQzVELElBQUksR0FBRyxDQUFDO0FBQ1IsSUFBSSxHQUFHLENBQUM7QUFDUixJQUFJLFVBQVUsQ0FBQzs7OztBQUlmLFNBQVMsVUFBVSxHQUFHO0FBQ2xCLE1BQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDdEQsTUFBSSxVQUFVLEdBQUc7QUFDZixVQUFNLEVBQUUsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQyxPQUFPLENBQUM7QUFDakQsUUFBSSxFQUFFLEVBQUU7QUFDUixhQUFTLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTztBQUN4QyxlQUFXLEVBQUUsS0FBSyxFQUNuQixDQUFDO0FBQ0YsS0FBRyxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQ2pELFNBQU8sQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFDOztBQUV4QixNQUFJLFNBQVMsQ0FBQyxXQUFXLEVBQUU7QUFDekIsYUFBUyxDQUFDLFdBQVcsQ0FBQyxrQkFBa0IsQ0FBQyxVQUFVLFFBQVEsRUFBRTtBQUMzRCxTQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ2xGLFVBQUksVUFBVSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUM7QUFDMUMsV0FBRyxFQUFFLEdBQUc7QUFDUixnQkFBUSxFQUFFLEdBQUc7QUFDYixtQkFBVyxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDO0FBQ3pDLGVBQU8sRUFBRSxZQUFZO09BQ3RCLENBQUMsQ0FBQztBQUNILFVBQUksTUFBTSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUM7QUFDbEMsZ0JBQVEsRUFBRSxHQUFHO0FBQ2IsV0FBRyxFQUFFLEdBQUc7QUFDUixpQkFBUyxFQUFFLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUk7QUFDckMsYUFBSyxFQUFFLDBCQUEwQjtPQUNsQyxDQUFDLENBQUM7O0FBRUgsWUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLE1BQU0sRUFBRSxPQUFPLEVBQUUsWUFBWSxDQUFDLENBQUM7O0FBRTdELGVBQVMsWUFBWSxHQUFHO0FBQ3RCLFlBQUksTUFBTSxDQUFDLFlBQVksRUFBRSxLQUFLLElBQUksRUFBRTtBQUNsQyxnQkFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQztTQUMzQixNQUFNO0FBQ0wsZ0JBQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7U0FDbkQ7T0FDRjtBQUNELFlBQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxNQUFNLEVBQUUsT0FBTyxFQUFFLFlBQVk7QUFDekQsa0JBQVUsQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE1BQU0sQ0FBQyxDQUFDO09BQzlCLENBQUMsQ0FBQztBQUNILFNBQUcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7QUFDbkIsYUFBTyxDQUFDLEdBQUcsQ0FBQyxxQ0FBcUMsRUFBRSxHQUFHLENBQUMsQ0FBQzs7QUFFeEQsVUFBSSxVQUFVLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxhQUFhLENBQUMsQ0FBQztBQUN2RCxnQkFBVSxDQUFDLE9BQU8sR0FBRyxZQUFZO0FBQy9CLHNCQUFjLEVBQUUsQ0FBQztBQUNqQixpQkFBUyxDQUFDLEdBQUcsQ0FBQyxDQUFDO09BQ2hCLENBQUM7O0tBRUgsRUFBRSxZQUFZO0FBQ2IseUJBQW1CLENBQUMsSUFBSSxDQUFDLENBQUM7S0FDM0IsQ0FBQyxDQUFDO0dBQ0osTUFBTTs7QUFFTCx1QkFBbUIsQ0FBQyxLQUFLLENBQUMsQ0FBQztHQUM1QjtDQUNGOzs7Ozs7QUFNSCxTQUFTLGNBQWMsR0FBRztBQUN4QixNQUFJLE9BQU8sR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzVFLE1BQUksUUFBUSxHQUFHLDREQUE0RCxDQUFDOztBQUU1RSxHQUFDLENBQUMsR0FBRyxDQUFDLFFBQVEsR0FBRyxPQUFPLEVBQUUsVUFBVSxJQUFJLEVBQUU7QUFDeEMsV0FBTyxDQUFDLEdBQUcsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDMUIsUUFBSSxnQkFBZ0IsR0FBRyxFQUFFLENBQUM7QUFDMUIsUUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQztBQUNwRCxRQUFJLFlBQVksR0FBRyxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDdkMsV0FBTyxDQUFDLEdBQUcsQ0FBQyxzQ0FBc0MsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUM3RCxRQUFJLE9BQU8sR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDO0FBQ3BELFFBQUksWUFBWSxHQUFHLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUN2QyxRQUFJLFVBQVUsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLFlBQVksRUFBRSxZQUFZLENBQUMsQ0FBQztBQUNwRSxXQUFPLENBQUMsR0FBRyxDQUFDLG1DQUFtQyxFQUFFLFVBQVUsQ0FBQyxDQUFDO0FBQzdELFFBQUksYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDbkUsUUFBSSxrQkFBa0IsR0FBRyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLGlCQUFpQixFQUFFLENBQUMsaUJBQWlCLENBQUMsQ0FBQztBQUN2RixRQUFJLGlCQUFpQixHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDdkUsV0FBTyxDQUFDLEdBQUcsQ0FBQyx1Q0FBdUMsRUFBRSxVQUFVLEVBQUUsU0FBUyxFQUFFLGFBQWEsRUFBRSxvQkFBb0IsQ0FBQyxDQUFDO0FBQ2pILFFBQUksYUFBYSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLEVBQUUsYUFBYSxDQUFDLENBQUM7QUFDckcsUUFBSSxlQUFlLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLHNCQUFzQixDQUFDLFVBQVUsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO0FBQzVHLFFBQUksY0FBYyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxzQkFBc0IsQ0FBQyxVQUFVLEVBQUUsaUJBQWlCLENBQUMsQ0FBQztBQUMxRyxvQkFBZ0IsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGVBQWUsRUFBRSxhQUFhLENBQUMsQ0FBQztBQUN0RSxRQUFJLGNBQWMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQztBQUM1RCxRQUFJLGVBQWUsR0FBRyxTQUFsQixlQUFlLEdBQWU7QUFDaEMsVUFBSSxjQUFjLEtBQUssYUFBYSxFQUFFO0FBQ3BDLGVBQU8sYUFBYSxDQUFDO09BQ3RCLE1BQU0sSUFBSSxjQUFjLEtBQUssY0FBYyxFQUFFO0FBQzVDLGVBQU8saUJBQWlCLENBQUM7T0FDMUIsTUFBTSxJQUFJLGNBQWMsS0FBSyxlQUFlLEVBQUU7QUFDN0MsZUFBTyxrQkFBa0IsQ0FBQztPQUMzQjtLQUNGLENBQUMsZUFBZSxFQUFFLENBQUM7QUFDcEIsUUFBSSxhQUFhLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUN6QyxjQUFRLEVBQUUsYUFBYTtBQUN2QixTQUFHLEVBQUUsR0FBRztBQUNSLFVBQUksRUFBRSwrREFBK0Q7S0FDeEUsQ0FBQyxDQUFDO0dBQUMsQ0FBQyxDQUFDO0NBQ1A7O0FBRUQsU0FBUyxtQkFBbUIsQ0FBQyxTQUFTLEVBQUU7QUFDcEMsTUFBSSxTQUFTLEVBQUU7QUFDYixRQUFJLE9BQU8sR0FBRyxvRUFBb0UsQ0FBQztHQUNwRixNQUFNO0FBQ0wsUUFBSSxPQUFPLEdBQUcsc0RBQXNELENBQUM7R0FDdEU7QUFDRCxNQUFJLE9BQU8sR0FBRztBQUNaLE9BQUcsRUFBRSxHQUFHO0FBQ1IsWUFBUSxFQUFFLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUFFLE9BQU8sQ0FBQztBQUNsRCxXQUFPLEVBQUUsT0FBTztHQUNqQixDQUFDO0FBQ0YsTUFBSSxVQUFVLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUMsQ0FBQztBQUNyRCxLQUFHLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztDQUNqQzs7OztBQUlILElBQUksU0FBUyxHQUFHLFFBQVEsQ0FBQyxjQUFjLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDbkQsQ0FBQyxTQUFTLGNBQWMsQ0FBQyxLQUFLLEVBQUU7O0FBRTlCLE1BQUksaUJBQWlCLEdBQUcsQUFBQyxLQUFLLENBQUMsZ0JBQWdCLEdBQUksS0FBSyxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxXQUFXLENBQUM7O0FBRTlGLFdBQVMsdUJBQXVCLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRTs7O0FBRy9DLFFBQUksSUFBSSxJQUFJLFNBQVMsRUFBRTtBQUNyQixVQUFJLGFBQWEsR0FBRyxRQUFRLENBQUM7QUFDN0IsY0FBUSxHQUFHLFVBQVUsS0FBSyxFQUFFO0FBQzFCLFlBQUksbUJBQW1CLEdBQUcsQ0FBQyxDQUFDLG9CQUFvQixDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztBQUM3RCxZQUFJLEtBQUssQ0FBQyxLQUFLLElBQUksRUFBRSxJQUFJLENBQUMsbUJBQW1CLEVBQUU7QUFDN0MsY0FBSSxtQkFBbUIsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLFNBQVMsRUFBRTtBQUMzQyxtQkFBTyxFQUFFLEVBQUU7QUFDWCxpQkFBSyxFQUFFLEVBQUU7V0FDVixDQUFDLENBQUM7QUFDSCx1QkFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDLENBQUM7U0FDbkQ7QUFDRCxxQkFBYSxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDO09BQ3JDLENBQUM7S0FDSDs7QUFFRCxxQkFBaUIsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDLENBQUM7R0FDbEQ7QUFDRCxNQUFJLEtBQUssQ0FBQyxnQkFBZ0IsRUFDeEIsS0FBSyxDQUFDLGdCQUFnQixHQUFHLHVCQUF1QixDQUFDLEtBQzlDLElBQUksS0FBSyxDQUFDLFdBQVcsRUFDeEIsS0FBSyxDQUFDLFdBQVcsR0FBRyx1QkFBdUIsQ0FBQztDQUMvQyxDQUFBLENBQUUsU0FBUyxDQUFDLENBQUM7QUFDZCxDQUFDLENBQUMsWUFBWTtBQUNaLE1BQUksWUFBWSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0NBQ25FLENBQUMsQ0FBQzs7OztBQUlILFNBQVMsU0FBUyxDQUFDLEdBQUcsRUFBRSxVQUFVLEVBQUUsZUFBZSxFQUFFO0FBQ25ELFNBQU8sQ0FBQyxHQUFHLENBQUMsZ0JBQWdCLEVBQUUsY0FBYyxDQUFDLENBQUM7OztBQUc5QyxNQUFJLE9BQU8sR0FBRyxFQUFFLENBQUM7QUFDbkIsUUFBTSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsVUFBUyxLQUFLLEVBQUU7QUFDeEQsYUFBUyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQztHQUN6QixDQUFDLENBQUM7QUFDTCxXQUFTLFNBQVMsQ0FBQyxNQUFNLEVBQUU7QUFDekIsUUFBSSxNQUFNLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQztBQUNsQyxjQUFRLEVBQUUsTUFBTTtBQUNoQixTQUFHLEVBQUUsR0FBRztBQUNSLFdBQUssRUFBRSwrREFBK0Q7S0FDdkUsQ0FBQyxDQUFDO0FBQ0gsV0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztHQUN0Qjs7OztBQUlDLE1BQUksT0FBTyxHQUFHLFFBQVEsQ0FBQyxhQUFhLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxDQUFDO0FBQ3BELE1BQUksYUFBYSxHQUFHLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7QUFDdEUsTUFBSSxNQUFNLEdBQUcsQ0FBQztBQUNaLFlBQVEsRUFBRSxhQUFhO0FBQ3ZCLFlBQVEsRUFBRSxJQUFJO0dBQ2YsQ0FBQyxDQUFDO0FBQ0gsbUJBQWlCLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7QUFDekQsbUJBQWlCLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQzlCLFdBQVMsQ0FBQyxXQUFXLENBQUMsa0JBQWtCLENBQUMsVUFBVSxRQUFRLEVBQUU7QUFDM0QsUUFBSSxHQUFHLEdBQUcsSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxRQUFRLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQ3hGLFFBQUksT0FBTyxHQUFHO0FBQ1osWUFBTSxFQUFFLEdBQUc7QUFDWCxpQkFBVyxFQUFFLE9BQU87QUFDcEIsZUFBUyxFQUFFLE1BQU07O0FBRWpCLHVCQUFpQixFQUFFLEtBQUs7QUFDeEIsZ0JBQVUsRUFBRSxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPO0tBQzNDLENBQUM7QUFDRixXQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxNQUFNLENBQUMsQ0FBQztBQUM5QixXQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRyxHQUFHLENBQUMsQ0FBQztBQUN6QixXQUFPLENBQUMsR0FBRyxDQUFDLEtBQUssRUFBRSxHQUFHLENBQUMsQ0FBQztBQUN4QixXQUFPLENBQUMsR0FBRyxDQUFDLDhDQUE4QyxFQUFFLE9BQU8sQ0FBQyxDQUFDOztBQUVyRSxxQkFBaUIsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLFVBQVUsUUFBUSxFQUFFLE1BQU0sRUFBRTtBQUMzRCxVQUFJLE1BQU0sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEVBQUUsRUFBRTtBQUM3Qyx5QkFBaUIsQ0FBQyxhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7T0FDM0M7S0FDRixDQUFDLENBQUM7R0FDRixDQUFDLENBQUM7Q0FDSjtBQUNELE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGNBQWMsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsY0FBYyxDQUFDLENBQUMiLCJmaWxlIjoic3JjL2pzL21haW4uanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgZGlyZWN0aW9uc0Rpc3BsYXk7XG52YXIgZGlyZWN0aW9uc1NlcnZpY2UgPSBuZXcgZ29vZ2xlLm1hcHMuRGlyZWN0aW9uc1NlcnZpY2UoKTtcbnZhciBtYXA7XG52YXIgcG9zO1xudmFyIGRlc3RMYXRMbmc7XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vc3RhcnQgdGhlIHBhcnR5XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbmZ1bmN0aW9uIGluaXRpYWxpemUoKSB7XG4gICAgdmFyIG1hcENhbnZhcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtYXAtY2FudmFzJyk7IC8vZGl2IGluIHRoZSBodG1sXG4gICAgdmFyIG1hcE9wdGlvbnMgPSB7XG4gICAgICBjZW50ZXI6IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoMzYuMTY2NywgLTg2Ljc4MzMpLCAvL05hc2hWZWdhcywgVE5cbiAgICAgIHpvb206IDE1LFxuICAgICAgbWFwVHlwZUlkOiBnb29nbGUubWFwcy5NYXBUeXBlSWQuUk9BRE1BUCxcbiAgICAgIHNjcm9sbHdoZWVsOiBmYWxzZSxcbiAgICB9O1xuICAgIG1hcCA9IG5ldyBnb29nbGUubWFwcy5NYXAobWFwQ2FudmFzLCBtYXBPcHRpb25zKTtcbiAgICBjb25zb2xlLmxvZygnbWFwJywgbWFwKTsgLy90aGlzIHdvcmtzLCBwcm9kdWNlcyBtYXAgb2JqZWN0XG4gICAgLy8gVHJ5IEhUTUw1IGdlb2xvY2F0aW9uXG4gICAgaWYgKG5hdmlnYXRvci5nZW9sb2NhdGlvbikge1xuICAgICAgbmF2aWdhdG9yLmdlb2xvY2F0aW9uLmdldEN1cnJlbnRQb3NpdGlvbihmdW5jdGlvbiAocG9zaXRpb24pIHtcbiAgICAgICAgcG9zID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZyhwb3NpdGlvbi5jb29yZHMubGF0aXR1ZGUsIHBvc2l0aW9uLmNvb3Jkcy5sb25naXR1ZGUpO1xuICAgICAgICB2YXIgaW5mb3dpbmRvdyA9IG5ldyBnb29nbGUubWFwcy5JbmZvV2luZG93KHtcbiAgICAgICAgICBtYXA6IG1hcCxcbiAgICAgICAgICBwb3NpdGlvbjogcG9zLFxuICAgICAgICAgIHBpeGVsT2Zmc2V0OiBuZXcgZ29vZ2xlLm1hcHMuU2l6ZSgwLCAtMjApLFxuICAgICAgICAgIGNvbnRlbnQ6ICdTdGFydCBoZXJlJ1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIG1hcmtlciA9IG5ldyBnb29nbGUubWFwcy5NYXJrZXIoe1xuICAgICAgICAgIHBvc2l0aW9uOiBwb3MsXG4gICAgICAgICAgbWFwOiBtYXAsXG4gICAgICAgICAgYW5pbWF0aW9uOiBnb29nbGUubWFwcy5BbmltYXRpb24uRFJPUCxcbiAgICAgICAgICB0aXRsZTogJ1RoaXMgaXMgeW91ciBnZW9sb2NhdGlvbidcbiAgICAgICAgfSk7XG4gICAgICAgIC8vY29waWVkIHRoZSBuZXh0IHNpeCBsaW5lcyBmcm9tIGdvb2dsZSwgbm90IGdvbm5hIGxpZVxuICAgICAgICBnb29nbGUubWFwcy5ldmVudC5hZGRMaXN0ZW5lcihtYXJrZXIsICdjbGljaycsIHRvZ2dsZUJvdW5jZSk7XG5cbiAgICAgICAgZnVuY3Rpb24gdG9nZ2xlQm91bmNlKCkge1xuICAgICAgICAgIGlmIChtYXJrZXIuZ2V0QW5pbWF0aW9uKCkgIT09IG51bGwpIHtcbiAgICAgICAgICAgIG1hcmtlci5zZXRBbmltYXRpb24obnVsbCk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG1hcmtlci5zZXRBbmltYXRpb24oZ29vZ2xlLm1hcHMuQW5pbWF0aW9uLkJPVU5DRSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcmtlciwgJ2NsaWNrJywgZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGluZm93aW5kb3cub3BlbihtYXAsIG1hcmtlcik7IC8vdGhpcyBzaG91bGQgYmUgcmVkb25lIGluIHRoZSBpbmZvYm94IGNsYXNzXG4gICAgICAgIH0pO1xuICAgICAgICBtYXAuc2V0Q2VudGVyKHBvcyk7XG4gICAgICAgIGNvbnNvbGUubG9nKCdtYXAgaW5zaWRlIHRoZSBnZW9sb2NhdGlvbiBmdW5jdGlvbicsIG1hcCk7XG4gICAgICAgIC8vcmVmYWN0b3JlZCBjb2RlIGZyb20gd2VhdGhlciBhcHBcbiAgICAgICAgdmFyIGJ0bldoZXJlVG8gPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCcjYnRuV2hlcmVUbycpOyAvL2NyZWF0ZXMgdGhlIGJ1dHRvbiBlbGVtZW50IHVzaW5nIHRoZSBpZCBmcm9tIHRoZSBidXR0b24gaW5wdXRcbiAgICAgICAgYnRuV2hlcmVUby5vbmNsaWNrID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgIGNsb3Nlc3RIb290ZXJzKCk7XG4gICAgICAgICAgY2FsY1JvdXRlKHBvcyk7XG4gICAgICAgIH07XG4gICAgICAgIC8vYWRkcyB0aGUgY2FsY3JvdXRlIHdpdGhpbiBnZW9sb2NhdGlvbiBiZWNhdXNlIGdlb2xvY2F0aW9uIGlzIHRoZSBzdGFydGluZyBwb2ludFxuICAgICAgfSwgZnVuY3Rpb24gKCkge1xuICAgICAgICBoYW5kbGVOb0dlb2xvY2F0aW9uKHRydWUpO1xuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIEJyb3dzZXIgZG9lc24ndCBzdXBwb3J0IEdlb2xvY2F0aW9uXG4gICAgICBoYW5kbGVOb0dlb2xvY2F0aW9uKGZhbHNlKTtcbiAgICB9XG4gIH1cbiAgLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vXG4gIC8vZGVzdExhdExuZyByZXR1cm5zIGEgc3RyaW5nLFxuICAvL3doaWNoIGJyZWFrcyB0aGUgYXBwXG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xuIFxuZnVuY3Rpb24gY2xvc2VzdEhvb3RlcnMoKSB7XG4gIHZhciB3aGVyZVRvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3doZXJlVG8nKS52YWx1ZS5zcGxpdCgnICcpLmpvaW4oJysnKTtcbiAgdmFyIE1BUFNfVVJMID0gJ2h0dHBzOi8vbWFwcy5nb29nbGVhcGlzLmNvbS9tYXBzL2FwaS9nZW9jb2RlL2pzb24/YWRkcmVzcz0nO1xuXG4gICQuZ2V0KE1BUFNfVVJMICsgd2hlcmVUbywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICBjb25zb2xlLmxvZygnZGF0YScsIGRhdGEpOyAvL25vdyBpdCBzZWVzIHRoaXNcbiAgICB2YXIgaG9vdGVyc0Rpc3RhbmNlcyA9IFtdO1xuICAgIHZhciBkZXN0TGF0ID0gZGF0YS5yZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uLmxhdDtcbiAgICB2YXIgZGVzdExhdENvb3JkID0gcGFyc2VGbG9hdChkZXN0TGF0KTsgLy9vdGhlcndpc2UgcmV0dXJucyBhIHN0cmluZ1xuICAgIGNvbnNvbGUubG9nKFwiZGVzdGluYXRpb24gbGF0aXR1ZGUgd2l0aCBwYXJzdEZsb2F0XCIsIGRlc3RMYXQpO1xuICAgIHZhciBkZXN0TG5nID0gZGF0YS5yZXN1bHRzWzBdLmdlb21ldHJ5LmxvY2F0aW9uLmxuZztcbiAgICB2YXIgZGVzdExuZ0Nvb3JkID0gcGFyc2VGbG9hdChkZXN0TG5nKTtcbiAgICB2YXIgZGVzdExhdExuZyA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcoZGVzdExhdENvb3JkLCBkZXN0TG5nQ29vcmQpO1xuICAgIGNvbnNvbGUubG9nKFwiYm90aCB0b2dldGhlcjsgYXJlIHRoZXNlIG51bWJlcnM/XCIsIGRlc3RMYXRMbmcpO1xuICAgIHZhciBob290ZXJzMm5kQXZlID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZygzNi4xNjE4OTE0LCAtODYuNzg5NDY0KTtcbiAgICB2YXIgaG9vdGVyc0xlYmFub25QaWtlID0gbmV3IGdvb2dsZS5tYXBzLkxhdExuZygzNi4xODYzMzM3MDAwMDAwMSwgLTg2LjYzMzE0Nzk5OTk5OTk5KTtcbiAgICB2YXIgaG9vdGVyc0xhcmdvRHJpdmUgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjA4MTUxNCwgLTg2LjcwOTU0MTMpO1xuICAgIGNvbnNvbGUubG9nKFwiYm90aCB0b2dldGhlciBhbmQgdGhlIDJuZCBBdmUgSG9vdGVyc1wiLCBkZXN0TGF0TG5nLCBcIjJuZCBBdmVcIiwgaG9vdGVyczJuZEF2ZSwgXCJhcmUgdGhlc2Ugb2JqZWN0cz9cIik7XG4gICAgdmFyIGRpc3RTZWNvbmRBdmUgPSBnb29nbGUubWFwcy5nZW9tZXRyeS5zcGhlcmljYWwuY29tcHV0ZURpc3RhbmNlQmV0d2VlbihkZXN0TGF0TG5nLCBob290ZXJzMm5kQXZlKTtcbiAgICB2YXIgZGlzdExlYmFub25QaWtlID0gZ29vZ2xlLm1hcHMuZ2VvbWV0cnkuc3BoZXJpY2FsLmNvbXB1dGVEaXN0YW5jZUJldHdlZW4oZGVzdExhdExuZywgaG9vdGVyc0xlYmFub25QaWtlKTtcbiAgICB2YXIgZGlzdExhcmdvRHJpdmUgPSBnb29nbGUubWFwcy5nZW9tZXRyeS5zcGhlcmljYWwuY29tcHV0ZURpc3RhbmNlQmV0d2VlbihkZXN0TGF0TG5nLCBob290ZXJzTGFyZ29Ecml2ZSk7XG4gICAgaG9vdGVyc0Rpc3RhbmNlcy5wdXNoKGRpc3RMYXJnb0RyaXZlLCBkaXN0TGViYW5vblBpa2UsIGRpc3RTZWNvbmRBdmUpO1xuICAgIHZhciBuZWFyZXN0SG9vdGVycyA9IE1hdGgubWluLmFwcGx5KE1hdGgsIGhvb3RlcnNEaXN0YW5jZXMpO1xuICAgIHZhciBob290ZXJzV2F5cG9pbnQgPSBmdW5jdGlvbiAoKSB7XG4gICAgICBpZiAobmVhcmVzdEhvb3RlcnMgPT09IGRpc3RTZWNvbmRBdmUpIHtcbiAgICAgICAgcmV0dXJuIGhvb3RlcnMybmRBdmU7XG4gICAgICB9IGVsc2UgaWYgKG5lYXJlc3RIb290ZXJzID09PSBkaXN0TGFyZ29Ecml2ZSkge1xuICAgICAgICByZXR1cm4gaG9vdGVyc0xhcmdvRHJpdmU7XG4gICAgICB9IGVsc2UgaWYgKG5lYXJlc3RIb290ZXJzID09PSBkaXN0TGViYW5vblBpa2UpIHtcbiAgICAgICAgcmV0dXJuIGhvb3RlcnNMZWJhbm9uUGlrZTtcbiAgICAgIH1cbiAgICB9O2hvb3RlcnNXYXlwb2ludCgpO1xuICAgIHZhciBob290ZXJzTWFya2VyID0gbmV3IGdvb2dsZS5tYXBzLk1hcmtlcih7XG4gICAgICBwb3NpdGlvbjogaG9vdGVyczJuZEF2ZSxcbiAgICAgIG1hcDogbWFwLFxuICAgICAgaWNvbjogJ2h0dHA6Ly9lZHdpbmFjZXZlZG8uY29tL2RpcmVjdGlvbnNGcm9tL2ltZy9ob290ZXJzLW1hcmtlci5wbmcnXG4gIH0pO30pO1xufVxuXG5mdW5jdGlvbiBoYW5kbGVOb0dlb2xvY2F0aW9uKGVycm9yRmxhZykge1xuICAgIGlmIChlcnJvckZsYWcpIHtcbiAgICAgIHZhciBjb250ZW50ID0gJ0F3IHNuYXAhIFNvbWV0aGluZyB3ZW50IHdyb25nIHdpdGggdGhlIEdlb2xvY2F0aW9uIHNlcnZpY2UuIFNvcnJ5Pyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIHZhciBjb250ZW50ID0gJ0F3LCBzbmFwISBZb3VyIGJyb3dzZXIgZG9lc25cXCd0IHN1cHBvcnQgZ2VvbG9jYXRpb24uJztcbiAgICB9XG4gICAgdmFyIG9wdGlvbnMgPSB7XG4gICAgICBtYXA6IG1hcCxcbiAgICAgIHBvc2l0aW9uOiBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE2NjcsIDg2Ljc4MzMpLFxuICAgICAgY29udGVudDogY29udGVudFxuICAgIH07XG4gICAgdmFyIGluZm93aW5kb3cgPSBuZXcgZ29vZ2xlLm1hcHMuSW5mb1dpbmRvdyhvcHRpb25zKTtcbiAgICBtYXAuc2V0Q2VudGVyKG9wdGlvbnMucG9zaXRpb24pO1xuICB9XG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbiAgLy9hdXRvY29tcGxldGUgZm9yIHRoZSBzZWFyY2ggYm94XG4gIC8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vL1xudmFyIHBhY19pbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd3aGVyZVRvJyk7XG4oZnVuY3Rpb24gcGFjU2VsZWN0Rmlyc3QoaW5wdXQpIHtcbiAgLy8gc3RvcmUgdGhlIG9yaWdpbmFsIGV2ZW50IGJpbmRpbmcgZnVuY3Rpb25cbiAgdmFyIF9hZGRFdmVudExpc3RlbmVyID0gKGlucHV0LmFkZEV2ZW50TGlzdGVuZXIpID8gaW5wdXQuYWRkRXZlbnRMaXN0ZW5lciA6IGlucHV0LmF0dGFjaEV2ZW50O1xuXG4gIGZ1bmN0aW9uIGFkZEV2ZW50TGlzdGVuZXJXcmFwcGVyKHR5cGUsIGxpc3RlbmVyKSB7XG4gICAgLy8gU2ltdWxhdGUgYSAnZG93biBhcnJvdycga2V5cHJlc3Mgb24gaGl0dGluZyAncmV0dXJuJyB3aGVuIG5vIHBhYyBzdWdnZXN0aW9uIGlzIHNlbGVjdGVkLFxuICAgIC8vIGFuZCB0aGVuIHRyaWdnZXIgdGhlIG9yaWdpbmFsIGxpc3RlbmVyLlxuICAgIGlmICh0eXBlID09IFwia2V5ZG93blwiKSB7XG4gICAgICB2YXIgb3JpZ19saXN0ZW5lciA9IGxpc3RlbmVyO1xuICAgICAgbGlzdGVuZXIgPSBmdW5jdGlvbiAoZXZlbnQpIHtcbiAgICAgICAgdmFyIHN1Z2dlc3Rpb25fc2VsZWN0ZWQgPSAkKFwiLnBhYy1pdGVtLXNlbGVjdGVkXCIpLmxlbmd0aCA+IDA7XG4gICAgICAgIGlmIChldmVudC53aGljaCA9PSAxMyAmJiAhc3VnZ2VzdGlvbl9zZWxlY3RlZCkge1xuICAgICAgICAgIHZhciBzaW11bGF0ZWRfZG93bmFycm93ID0gJC5FdmVudChcImtleWRvd25cIiwge1xuICAgICAgICAgICAga2V5Q29kZTogNDAsXG4gICAgICAgICAgICB3aGljaDogNDBcbiAgICAgICAgICB9KTtcbiAgICAgICAgICBvcmlnX2xpc3RlbmVyLmFwcGx5KGlucHV0LCBbc2ltdWxhdGVkX2Rvd25hcnJvd10pO1xuICAgICAgICB9XG4gICAgICAgIG9yaWdfbGlzdGVuZXIuYXBwbHkoaW5wdXQsIFtldmVudF0pO1xuICAgICAgfTtcbiAgICB9XG4gICAgLy8gYWRkIHRoZSBtb2RpZmllZCBsaXN0ZW5lclxuICAgIF9hZGRFdmVudExpc3RlbmVyLmFwcGx5KGlucHV0LCBbdHlwZSwgbGlzdGVuZXJdKTtcbiAgfVxuICBpZiAoaW5wdXQuYWRkRXZlbnRMaXN0ZW5lcilcbiAgICBpbnB1dC5hZGRFdmVudExpc3RlbmVyID0gYWRkRXZlbnRMaXN0ZW5lcldyYXBwZXI7XG4gIGVsc2UgaWYgKGlucHV0LmF0dGFjaEV2ZW50KVxuICAgIGlucHV0LmF0dGFjaEV2ZW50ID0gYWRkRXZlbnRMaXN0ZW5lcldyYXBwZXI7XG59KShwYWNfaW5wdXQpO1xuJChmdW5jdGlvbiAoKSB7XG4gIHZhciBhdXRvY29tcGxldGUgPSBuZXcgZ29vZ2xlLm1hcHMucGxhY2VzLkF1dG9jb21wbGV0ZShwYWNfaW5wdXQpO1xufSk7XG4vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbi8vZHJhdyB0aGUgcm91dGUgb24gdGhlIG1hcFxuLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy8vLy9cbmZ1bmN0aW9uIGNhbGNSb3V0ZShwb3MsIGRlc3RMYXRMbmcsIGhvb3RlcnNXYXlwb2ludCkge1xuICBjb25zb2xlLmxvZygnY2xvc2VzdEhvb3RlcnMnLCBjbG9zZXN0SG9vdGVycyk7XG5cbi8vcGxhY2luZyB0aGUgb3dsLCB0aGVzZSBsaW5lcyBmcm9tIGhlcmVcbiAgdmFyIG1hcmtlcnMgPSBbXTtcbmdvb2dsZS5tYXBzLmV2ZW50LmFkZExpc3RlbmVyKG1hcCwgJ2NsaWNrJywgZnVuY3Rpb24oZXZlbnQpIHtcbiAgICBhZGRNYXJrZXIoZXZlbnQubGF0TG5nKTtcbiAgfSk7XG5mdW5jdGlvbiBhZGRNYXJrZXIod2F5cHRzKSB7XG4gIHZhciBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcbiAgICBwb3NpdGlvbjogd2F5cHRzLFxuICAgIG1hcDogbWFwLFxuICAgIGltYWdlOiAnaHR0cDovL2Vkd2luYWNldmVkby5jb20vZGlyZWN0aW9uc0Zyb20vaW1nL2hvb3RlcnMtbWFya2VyLnBuZydcbiAgfSk7XG4gIG1hcmtlcnMucHVzaChtYXJrZXIpO1xufVxuXG4vL3RvIGhlcmVcbiAgXG4gIHZhciB3aGVyZVRvID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI3doZXJlVG8nKS52YWx1ZTtcbiAgICAgdmFyIGhvb3RlcnMybmRBdmUgPSBuZXcgZ29vZ2xlLm1hcHMuTGF0TG5nKDM2LjE2MTg5MTQsIC04Ni43ODk0NjQpO1xuICB2YXIgd2F5cHRzID0gW3tcbiAgICBsb2NhdGlvbjogaG9vdGVyczJuZEF2ZSwgLy90aGlzIGlzIHVuZGVmaW5lZFxuICAgIHN0b3BvdmVyOiB0cnVlXG4gIH1dO1xuICBkaXJlY3Rpb25zRGlzcGxheSA9IG5ldyBnb29nbGUubWFwcy5EaXJlY3Rpb25zUmVuZGVyZXIoKTtcbiAgZGlyZWN0aW9uc0Rpc3BsYXkuc2V0TWFwKG1hcCk7XG4gIG5hdmlnYXRvci5nZW9sb2NhdGlvbi5nZXRDdXJyZW50UG9zaXRpb24oZnVuY3Rpb24gKHBvc2l0aW9uKSB7XG4gICAgdmFyIHBvcyA9IG5ldyBnb29nbGUubWFwcy5MYXRMbmcocG9zaXRpb24uY29vcmRzLmxhdGl0dWRlLCBwb3NpdGlvbi5jb29yZHMubG9uZ2l0dWRlKTtcbiAgdmFyIHJlcXVlc3QgPSB7XG4gICAgb3JpZ2luOiBwb3MsIC8vZnJvbSBnZW9sb2NhdGlvblxuICAgIGRlc3RpbmF0aW9uOiB3aGVyZVRvLCAvL2Zyb20gaW5wdXQudmFsdWUgb2YgI3doZXJlVG9cbiAgICB3YXlwb2ludHM6IHdheXB0cyxcbiAgICAvL3BsYWNlSWQ6ICdDaElKT3dFN19HVHR3b2tSRnEwdU93TFNFOWcnXG4gICAgb3B0aW1pemVXYXlwb2ludHM6IGZhbHNlLFxuICAgIHRyYXZlbE1vZGU6IGdvb2dsZS5tYXBzLlRyYXZlbE1vZGUuRFJJVklOR1xuICB9O1xuICBjb25zb2xlLmxvZygnd2F5cHRzJywgd2F5cHRzKTtcbiAgY29uc29sZS5sb2coJ21hcCcsICBtYXApO1xuICBjb25zb2xlLmxvZygncG9zJywgcG9zKTtcbiAgY29uc29sZS5sb2coJ3doZXJlVG8sIHRoaXMgdGltZSBpbmNsdWRpbmcgdGhlIGlucHV0LnZhbHVlJywgd2hlcmVUbyk7XG5cbiAgZGlyZWN0aW9uc1NlcnZpY2Uucm91dGUocmVxdWVzdCwgZnVuY3Rpb24gKHJlc3BvbnNlLCBzdGF0dXMpIHtcbiAgICBpZiAoc3RhdHVzID09IGdvb2dsZS5tYXBzLkRpcmVjdGlvbnNTdGF0dXMuT0spIHtcbiAgICAgIGRpcmVjdGlvbnNEaXNwbGF5LnNldERpcmVjdGlvbnMocmVzcG9uc2UpO1xuICAgIH1cbiAgfSk7XG4gIH0pO1xufVxuZ29vZ2xlLm1hcHMuZXZlbnQuYWRkRG9tTGlzdGVuZXIod2luZG93LCAnbG9hZCcsIGluaXRpYWxpemUsIGNhbGNSb3V0ZSwgY2xvc2VzdEhvb3RlcnMpO1xuIl19